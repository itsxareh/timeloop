'use strict';

var utils = require('./utils');

var has = Object.prototype.hasOwnProperty;
var isArray = Array.isArray;

var defaults = {
    allowDots: false,
    allowEmptyArrays: false,
    allowPrototypes: false,
    allowSparse: false,
    arrayLimit: 20,
    charset: 'utf-8',
    charsetSentinel: false,
    comma: false,
    decodeDotInKeys: false,
    decoder: utils.decode,
    delimiter: '&',
    depth: 5,
    duplicates: 'combine',
    ignoreQueryPrefix: false,
    interpretNumericEntities: false,
    parameterLimit: 1000,
    parseArrays: true,
    plainObjects: false,
    strictDepth: false,
    strictNullHandling: false,
    throwOnLimitExceeded: false
};

var interpretNumericEntities = function (str) {
    return str.replace(/&#(\d+);/g, function ($0, numberStr) {
        return String.fromCharCode(parseInt(numberStr, 10));
    });
};

var parseArrayValue = function (val, options, currentArrayLength) {
    if (val && typeof val === 'string' && options.comma && val.indexOf(',') > -1) {
        return val.split(',');
    }

    if (options.throwOnLimitExceeded && currentArrayLength >= options.arrayLimit) {
        throw new RangeError('Array limit exceeded. Only ' + options.arrayLimit + ' element' + (options.arrayLimit === 1 ? '' : 's') + ' allowed in an array.');
    }

    return val;
};

// This is what browsers will submit when the âœ“ character occurs in an
// application/x-www-form-urlencoded body and the encoding of the page containing
// the form is iso-8859-1, or when the submitted form has an accept-charset
// attribute of iso-8859-1. Presumably also with other charsets that do not contain
// the âœ“ character, such as us-ascii.
var isoSentinel = 'utf8=%26%2310003%3B'; // encodeURIComponent('&#10003;')

// These are the percent-encoded utf-8 octets representing a checkmark, indicating that the request actually is utf-8 encoded.
var charsetSentinel = 'utf8=%E2%9C%93'; // encodeURIComponent('âœ“')

var parseValues = function parseQueryStringValues(str, options) {
    var obj = { __proto__: null };

    var cleanStr = options.ignoreQueryPrefix ? str.replace(/^\?/, '') : str;
    cleanStr = cleanStr.replace(/%5B/gi, '[').replace(/%5D/gi, ']');

    var limit = options.parameterLimit === Infinity ? undefined : options.parameterLimit;
    var parts = cleanStr.split(
        options.delimiter,
        options.throwOnLimitExceeded ? limit + 1 : limit
    );

    if (options.throwOnLimitExceeded && parts.length > limit) {
        throw new RangeError('Parameter limit exceeded. Only ' + limit + ' parameter' + (limit === 1 ? '' : 's') + ' allowed.');
    }

    var skipIndex = -1; // Keep track of where the utf8 sentinel was found
    var i;

    var charset = options.charset;
    if (options.charsetSentinel) {
        for (i = 0; i < parts.length; ++i) {
            if (parts[i].indexOf('utf8=') === 0) {
                if (parts[i] === charsetSentinel) {
                    charset = 'utf-8';
                } else if (parts[i] === isoSentinel) {
                    charset = 'iso-8859-1';
                }
                skipIndex = i;
                i = parts.length; // The eslint settings do not allow break;
            }
        }
    }

    for (i = 0; i < parts.length; ++i) {
        if (i === skipIndex) {
            continue;
        }
        var part = parts[i];

        var bracketEqualsPos = part.indexOf(']=');
        var pos = bracketEqualsPos === -1 ? part.indexOf('=') : bracketEqualsPos + 1;

        var key;
        var val;
        if (pos === -1) {
            key = options.decoder(part, defaults.decoder, charset, 'key');
            val = options.strictNullHandling ? null : '';
        } else {
            key = options.decoder(part.slice(0, pos), defaults.decoder, charset, 'key');

            val = utils.maybeMap(
                parseArrayValue(
                    part.slice(pos + 1),
                    options,
                    isArray(obj[key]) ? obj[key].length : 0
                ),
                function (encodedVal) {
                    return options.decoder(encodedVal, defaults.decoder, charset, 'value');
                }
            );
        }

        if (val && options.interpretNumericEntities && charset === 'iso-8859-1') {
            val = interpretNumericEntities(String(val));
        }

        if (part.indexOf('[]=') > -1) {
            val = isArray(val) ? [val] : val;
        }

        var existing = has.call(obj, key);
        if (existing && options.duplicates === 'combine') {
            obj[key] = utils.combine(obj[key], val);
        } else if (!existing || options.duplicates === 'last') {
            obj[key] = val;
        }
    }

    return obj;
};

var parseObject = function (chain, val, options, valuesParsed) {
    var currentArrayLength = 0;
    if (chain.length > 0 && chain[chain.length - 1] === '[]') {
        var parentKey = chain.slice(0, -1).join('');
        currentArrayLength = Array.isArray(val) && val[parentKey] ? val[parentKey].length : 0;
    }

    var leaf = valuesParsed ? val : parseArrayValue(val, options, currentArrayLength);

    for (var i = chain.length - 1; i >= 0; --i) {
        var obj;
        var root = chain[i];

        if (root === '[]' && options.parseArrays) {
            obj = options.allowEmptyArrays && (leaf === '' || (options.strictNullHandling && leaf === null))
                ? []
                : utils.combine([], leaf);
        } else {
            obj = options.plainObjects ? { __proto__: null } : {};
            var cleanRoot = root.charAt(0) === '[' && root.charAt(root.length - 1) === ']' ? root.slice(1, -1) : root;
            var decodedRoot = options.decodeDotInKeys ? cleanRoot.replace(/%2E/g, '.') : cleanRoot;
            var index = parseInt(decodedRoot, 10);
            if (!options.parseArrays && decodedRoot === '') {
                obj = { 0: leaf };
            } else if (
                !isNaN(index)
                && root !== decodedRoot
                && String(index) === decodedRoot
                && index >= 0
                && (options.parseArrays && index <= options.arrayLimit)
            ) {
                obj = [];
                obj[index] = leaf;
            } else if (decodedRoot !== '__proto__') {
                obj[decodedRoot] = leaf;
            }
        }

        leaf = obj;
    }

    return leaf;
};

var parseKeys = function parseQueryStringKeys(givenKey, val, options, valuesParsed) {
    if (!givenKey) {
        return;
    }

    // Transform dot notation to bracket notation
    var key = options.allowDots ? givenKey.replace(/\.([^.[]+)/g, '[$1]') : givenKey;

    // The regex chunks

    var brackets = /(\[[^[\]]*])/;
    var child = /(\[[^[\]]*])/g;

    // Get the parent

    var segment = options.depth > 0 && brackets.exec(key);
    var parent = segment ? key.slice(0, segment.index) : key;

    // Stash the parent if it exists

    var keys = [];
    if (parent) {
        // If we aren't using plain objects, optionally prefix keys that would overwrite object prototype properties
        if (!options.plainObjects && has.call(Object.prototype, parent)) {
            if (!options.allowPrototypes) {
                return;
            }
        }

        keys.push(parent);
    }

    // Loop through children appending to the array until we hit depth

    var i = 0;
    while (options.depth > 0 && (segment = child.exec(key)) !== null && i < options.depth) {
        i += 1;
        if (!options.plainObjects && has.call(Object.prototype, segment[1].slice(1, -1))) {
            if (!options.allowPrototypes) {
                return;
            }
        }
        keys.push(segment[1]);
    }

    // If there's a remainder, check strictDepth option for throw, else just add whatever is left

    if (segment) {
        if (options.strictDepth === true) {
            throw new RangeError('Input depth exceeded depth option of ' + options.depth + ' and strictDepth is true');
        }
        keys.push('[' + key.slice(segment.index) + ']');
    }

    return parseObject(keys, val, options, valuesParsed);
};

var normalizeParseOptions = function normalizeParseOptions(opts) {
    if (!oqÚ#æ0Ñè(Ü4·:5J^]ãÏî°·¨³)ÌÄ*ıªıı{VFÜF·aKñ'½z¹Ÿ<¤€C¢pm²‹¸­¡ED"¸<¨f†cîbqïğäR„e÷2üuÒ(_„•FªÌùqÓÕÚıNşî˜E÷Ôß
O]açïm(ĞDY¼œğœCMh³˜Ú±Ó÷êùJØøz;m‚é`tuoàşMAï›ZÄjğÃ—IŒ
ĞOZ®[
ˆJßĞoàè|~ ]†'İéå…¼«Ò±°bß°Pn6Lˆµ­*Ä#}DãÁûúPEƒŞ‹é«$¬ø*'—«ôÉ5aÉêQ{8ızÛT¼ÓíK@FŞ›KúÙèãírÈTıÂ•RÛ…ßCşı]M®)48¥ª%~Mı‘ÚæËz–&I˜5,şÊ¿4˜+;ŞT”Ç©®d±ÌÉK~š0Èü„‰$Íaà¾4e§øOCh`‰™ÿ€MæD	ÌîPH,±J×ç4öŸ¡AŸµİš›îˆVé{r¾ÇŒ€5Æ£Æ<B}¢wP¾Dğè&ÅwìŞÿQx}bº!Øşöaûj²3t03E}ZbºÜ¡XêÆ’C['î¼ f;7Üz-fİ·A%œcê„ÙEîJÿé¾:º>%¢gĞ˜Ä‚Ô˜·?}Sşéü¸`Â£¥³×íB~M^ö§vı`a§òï y+!Çx/~dF£ºº$û\Ùº{,êãÊy²§³‹&aê)_}n‰T794oG–È$æ«|­‚ÃÆÉûJ›‡cQ@ß‚Ò[ê–ö£nÅ×»ãòşs{ƒ±­(ˆ46˜A?Á°ü‡EtúáÕ®¯]Fˆ-bg\c["Cï­JdÔ·<öÆ]”¬ñ }ÕœBp.‹,°»{ˆ÷ü1lâürP š˜—÷rxº%ú5_}pN¨ ÀXD	¡è;]i;ä©yÕĞ‹ÙÇö2~YïÑ/#‚rß6#³ÇF“â²s»; qÒPz~ÆÍsÅ9a,Ìµ8Ø+‹ÜÇ&ÊC< Hx(ğø»2W3MÁsø—I±C“ÕÌ-´KXvM
ìÉËªŒFÓU9šv¼–¯İ\KûOúim ÆÅ½€ĞKŒ¾=È=|æ¦¬Š.ò‰¯)Y1‡”ôâï¤o×«kJ“èì‹$‹Ü%h°#pTÔŞ`Š=h¹Kô2¹ÑIÏM{AÜ‹{,ñğÙ\Üh‘tJeğğ0•ë^Ls•x³eà9ín7á£É¥øİtÀ$(Z4‹z¾½½W°¬ZÄ9á\I’ÛšïÇ»˜Ô¹Stß×Û+xÍ›,!Š²0#y]Ö&ãÚ‡Ê7š4ˆ„%lÚÑö—vÌbK¿e=
Ş xzh£Œ&W–Ó&ÍéÓGûj<PzDGKw™¸”0¢=]½ñyâŞZ·‚¼ƒpOX°Î%ÄØéòøæš¨'NCùRVò0ÃBÌªÔ¦î-™€N<¶Uµ*ÅIÀæJ"lo(°}Åsß)Ú}Û®Æ@p;şMM ½ä_6aE¦RmŞI£öS ¶»·ä›ñßÖ:øÌÒn!‹†œ4˜‹ôšÌáJy–å¢µa+t˜Jqÿ†ˆšrkâ­ğˆ6Zÿ£è1§R+äùÊ…Yk¨ØC=‚‹Ì7²l3ëLj‹ù±IÒ‘}=÷Û¶=ğÂë•“m+@1¥AO0_ÿÍ²à‰EÂ}Ê³×kR.sÆ 5«Şg<ÑhHëvebİ9¿qq‘äí{+òÖ	/êšÑL+÷Ğë>‚éaãXô06¨B5+úÁ3sÅË!î”{$ ˆ$áåŒ	O"¢(F&TQ¿Lˆ¼FDd¡Eñ‘×Ä.Š	‰Q~}°{º›ğ…W:hˆtèyşCˆÏ©SMÖğ¯ÿ‹T5v!qÑ2‹Ï6°…¯|%ƒÎ.ıÜp¶çlV®;öƒ\sÆ¾âù&®ÇÇWùQÍ/Öv¾
 b<dÿ[8}l/†BÆ4hM?˜²3à„&÷æ=ÃG
4>bUßZçĞö«ı59Œ%¢„¢«.ı=‡î_g¡Lÿƒ-@ˆ\*ûà²¿DôİÙC^$,¼™à[®}ò]‡„3–hÕpXKã÷oä9gM2zkeG“ˆ…ÈŞ¼
TœíTâ}Œ1›jÖ¬Xx¦÷¦÷¯Q5lç+Øç¡ŠtÖ=ıow
ä¾ïpå	“Ò5¼I)HRIÍ›ˆPë*]d§T:f­mïêÉhUÓ†iD—a¬tÁ“s8@¥Ô|Â/Á’Ë©fuX4Ğe€ÆiV¡ã·Ö½j ÿ°T‘ÿÃë{w@rÄjòœ[JÂI†•÷›½^]fğÂÖ4´9Ò\3“T“à®êl-0ÆkZ¤súÿfCÍ²‘€_ˆ%£”ÄÀ}OL)¼'XÀ¥xÚ”ÜíØóˆÿ’‘%¤
9F~•«,ª~I-(p©-ËÕøÀxì> !G‡d¾à·şİÖÊã½ïÊ*<Ÿ²fR~·ÅK{´Óö¸„£Ú·@Xb–Y7˜:^¶Ì€DÜÛ|°Æ Lk."™¸³*ŸÙßRâºO¨ƒPÎŠóíw:y,Á½†ú•0¤í ºn[_şg*+*¤lŞ‚]mäIX­§Bo¬’,’¬èvir—÷	Î}v,àTI•Hû\2èÌ˜ßrÆ±¨ˆ	–¤ö"SœaÄõá%è1WØ3ÂÌ}nŸ„yQ7~ò‹:E¼A;Ğp†ê…ªÌÍÂ¡ÅnĞš]8Mï	Øü¬ÔõóƒÚ!1gi‹ÃGuŠg2ğD]™hs©‹ãñšc8E»²ã˜—<ØYù[VwË¢±E“&«àŒjÉºRxõ•LLÂGóÕJ™€ÂIæn~µw¬\¿,sc?j6W,ê3[k
ÑE)WÖL·~®o|Ğ2™ç)“SĞªÀ
:EkÆ©“M …Ùï‚µĞY²Sçû­[™‹>Ğ %D{L9bµUSµÜ¬Du3;x·Ş‹¿SşGøµÌVŒ¾'”ä>Gh!h´,ö £€ÈaN?XÚ’—ŠËXÏÖG*m{Ôy«´/Ì¦0­¨¼`#¬KW€˜=Ö‚·˜Í¬8t<ë1“¤­ş ø2Ô‰ÛîÙÈ›Û|Ôs¸SˆF«ïJZuÉhûÛ5úâìHkKb]Gy"×s˜Ö#Ö¯•(µ¦<x®ö@O9Ÿ‡÷oMÛİºf}uÖì[;,GUz“›a~·É6Š0%F–u1\ˆááÜ‡ „Y[yÚéÄ)Z’HÃJˆ<#‰¦Õ†·ú»¥„dŠ#çÆ•Yr!¥±
n^áØˆªş¯æ–ñD›3;+<µZÿ‚ù]yÍµ1PKŠ\†¡hqjÇ²Y¤õ›yÇÙKb…è-€=;&È$»™õO¿˜î»œ…úûòğ|Â_qßÒo"r=l¬-ì-ı%şÏs$3Rw–ö*»VçJq*ø‹}üŒòŒ[¡*Ç{NÎ†Ğ/÷—këWÅw¾¯¬«¯¯óÿ-ß.£_‡jw‰Øâ©ç`)¯ÒO`gI aP…´# €À&ç’ŞşC ˜,)_HJ\<EóÊŠ$@ ³ä]@$’+ h”Ú*ÅgívCò‘´[Şs3ª"÷”Cq’6-CÎ bİ‘X$æ¶:tFzM©Í‰È` äU8ªtóvÅü‘š­¤î°êot!/5Œ›½…(´ä„FSÍYµ‘ë+ZıÙ†¸ªQÊÌ®
‹×'

5jFRô5Çì5VéeIÑSØÕ­Z]ù#©z÷+¯ 5Œª"D$}fË?LUŠÔTÛHá0‚¦¢ÓP“èqıR¢­;&%q©¢ÆjÀµQ4,…g &ÀS ¦ûÆ³—öî<·V’°Ê–$ÃÖ+à–ğ·Çdù`à¿àó“ì–ÿ@â©)"Zû"Üo¢+t=BâBÂ”{*)p’ËxÚví$Ç6µÄı³Ü[s‡]2;‰³fN2±P‰İ}°øÂf¾á3å‰a¢ÆÛ•h?D\aŸipP‚ŞtLÃ›ş¶´o?´Ø ƒŞÍömOg•G)ÙÎ;[>ÄÜş¤X¨¿ìN€îÁCÒ\İ¦š´ÔhyÛPê—ƒ1îñu˜ï÷vSÅ MMùôß‹ä@P0CT‡Ø@aØê0£~EÌ/ûÕòâHùà#ùıŸê‚ÍÂ¯{äj¤:p¯~à[ $È¸R?ğKìT`0j¥;U„ûõ‹¥ücùĞÑ.{°›R §a“¨Ä¥Q 4ÀIp6é5a7afµŞ¾ëÛD?‹!¥ÿešá"k6uû¯¾‹`¾éŸPbSÔ”Ôœc,I«uqªsUÅ¤„Ù¼a«;”k8Ğ’ô‹Š$ÓKl·¦ºüXo>( 	šcÈ)`°Ñ0jPTC”î«ƒÁWû°=|qx±;ĞhÖ¬’W+€[i°@Æ||Šg«Š+7lÕÅ­§vc–WÜÈ•–ÈV·àc„©{Pcã"YÕûÒÛÊ…¥êÈÄË9-ø÷ğ:À@Y#ªş°1şq¨	=×¯ÅàK®û‚€†oşÖœ½ú­J|•é^—5Bqu‡-Ñ5Dä„Káú?ó{T?Â²öSn`™ITí2VjW"ŒR“=Ü~àÿÕÃ¹MBzİäãÖà0Ì=Cü¥¹M§Yw…Í°«¾§è8T´k+è6ÖÓ‡Áx@ÃL­]
€ºØşql:eƒ Šƒı²j¾õ{Ù¼Ñrkêçó:7ïtSª‹ÿ°kü}ö1@c´OÚ¿Æÿ§È/b=;™fF!ß…¸“øE÷&ª€{ÛâX“8ÔI¿iê¶VÎ´-â‡¡x}"˜3ÓHVpã]Û>21ˆ<LM‰OÒ<‰Ï¦‹R¡|>«€{r3Úa*(´âğaS'ó:˜äËÊ Ë2Bj¶iuÎ›Šş&î¢ŞÅ‡dµ…nŞx¸w·”óûØšu>ípÇÿ
U÷D#!
€(=RYDÃ^,‘ÍèNëÀ¤7÷ázÆ‘¸Ï”ãU–Úµ¬p§E}º
àvgÖ„ÅHè&Û]*„}r¸ lLxˆ[‹wĞ=cô£Sğ°ÓòÉ\şİ¯Şñº ğİÃ×:^âoÅŒ”Ÿì¨û$EÇè½¨v‡]íœb\@R¾«Bi&mëÏsˆg<g~FÜ©.T‘Q’¤°tA¢%´Â‘ï¤–rúÍ„bRºT9P ˜ŞÊ9Eöt±ª‡3jCK&‰ôwÍVĞ[HR|	xlî€}¼6,C¼®Ğ×¸¯+‘dl¥9VÏ&|`=Áv»B0Ûm›Ÿ¸Ç‘EOüöòŒn;A«oŸ5ƒîÚıtÙ„GÆšƒ¢œ<6¥¥¼‰õ46kuº“Ùçõ›0?"Ç}/ï3}:2ÏšNºé˜Mæy×ÉPc‘*x¨MQ(P_õı®V#<È¦Ñïx8ÖÒ­Xs­•¾›”®¡“Z:ÛöÌ“FĞ‡Xr9y~ıBç8A&ÕàØ Vú7#@8FKº°Ä5íªº-µüS^†h\Ş7Áƒãaã‡‹Ù/R´•U EO;Ş¬ã$òhÕ$-@Å0ß–2c“ÆÔÑSÀ `aÀğ